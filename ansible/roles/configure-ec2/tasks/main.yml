# -------------------------
# Apache Installation
# -------------------------
- name: Apache setup block
  block:

    - name: Install Apache
      become: true
      package:
        name: httpd
        state: present

    - name: Ensure Apache document root exists
      become: true
      file:
        path: /var/www/html
        state: directory
        mode: '0755'

    - name: Start and enable Apache
      become: true
      service:
        name: httpd
        state: started
        enabled: true

  rescue:
    - name: Apache failure reason
      debug:
        msg: |
          Apache failed to install or start.
          Possible causes:
          - Port 80 already in use
          - SELinux blocking httpd
          - Invalid httpd configuration

    - name: Show Apache status
      become: true
      command: systemctl status httpd
      register: apache_status
      failed_when: false

    - debug:
        var: apache_status.stdout

    - name: Force Apache failure
      fail:
        msg: "Apache setup failed. Aborting deployment."

  always:
    - debug:
        msg: "Apache setup block completed."


# -------------------------
# MariaDB (MySQL-compatible)
# -------------------------
- name: MariaDB setup block
  block:

    - name: Install MariaDB server
      become: true
      package:
        name: mariadb-server
        state: present

    - name: Start and enable MariaDB
      become: true
      service:
        name: mariadb
        state: started
        enabled: true

  rescue:
    - name: MariaDB failure reason
      debug:
        msg: |
          MariaDB failed to install or start.
          Possible causes:
          - Package repo unavailable
          - Port 3306 conflict
          - Permission issues

    - name: Show MariaDB status
      become: true
      command: systemctl status mariadb
      register: mariadb_status
      failed_when: false

    - debug:
        var: mariadb_status.stdout

    - name: Force MariaDB failure
      fail:
        msg: "MariaDB setup failed. Aborting deployment."

  always:
    - debug:
        msg: "MariaDB setup block completed."
